# Doctrine Migration Instructions

The scenario we're going to play out is one used pretty frequently: Adding a new column.

First we're going to test that the package runs under your local vagrant

```
$ vagrant ssh
$ cd /vagrant/schema
$ ./doctrine
```

You should see an output like the following:

```
Doctrine Command Line Interface version 2.4.1

Usage:
  [options] command [arguments]

Options:
  --help           -h Display this help message.
  --quiet          -q Do not output any message.
  --verbose        -v|vv|vvv Increase the verbosity of messages: 1 for normal output, 2 for more verbose output and 3 for debug
  --version        -V Display this application version.
  --ansi              Force ANSI output.
  --no-ansi           Disable ANSI output.
  --no-interaction -n Do not ask any interactive question.

Available commands:
  help                  Displays help for a command
  list                  Lists commands
migrations
  migrations:diff       Generate a migration by comparing your current database to your mapping information.
  migrations:execute    Execute a single migration version up or down manually.
  migrations:generate   Generate a blank migration class.
  migrations:migrate    Execute a migration to a specified version or the latest available version.
  migrations:status     View the status of a set of migrations.
  migrations:version    Manually add and delete migration versions from the version table.
```

Next, we're going to see if all the current migrations are applied:

```
$ ./doctrine m:s
```

First, did you notice that I used the shorthand notation for `migrations:status`? It's pretty handy, and as other Symfony built tools come into play we'll see more of that.

The command we just ran should give us some output on what migration we're on, if we're up to date, and finally if we have anything to sync.

```
 == Configuration

    >> Name:                                               Alert Project Migrations
    >> Database Driver:                                    pdo_mysql
    >> Database Name:                                      alert_test
    >> Configuration Source:                               /vagrant/schema/migrations.yml
    >> Version Table Name:                                 migration_version
    >> Migrations Namespace:                               Migrations
    >> Migrations Directory:                               /vagrant/schema/Migrations
    >> Current Version:                                    2013-09-26 07:23:05 (20130926072305)
    >> Latest Version:                                     2013-09-26 07:23:05 (20130926072305)
    >> Executed Migrations:                                90
    >> Available Migrations:                               90
    >> New Migrations:                                     0
```

Nothing is going on here. As you can see we're on migration 90, with 0 new migrations to run. Lets change that and add a new column to one of the tables.

# Adding a new column

New migrations can be added manually, or by generating a blank class. In this project the migrations themselves are located under:

```
schema/Migrations
```

They are named after the date/time of their generation to keep them nice and unique.

Lets generate an empty migration using doctrine's `migrations:generate` or `m:g` command.

```
$ ./doctrine m:g

Generated new migration class to "/vagrant/schema/Migrations/Version20131210165202.php"
```

Yours will be named differently, but you get the idea. We can now open up this new file in our editor and make some changes.

# Modifying Blank Migration Classes

Here it is. Super simple.

```
<?php

namespace Migrations;

use Doctrine\DBAL\Migrations\AbstractMigration,
    Doctrine\DBAL\Schema\Schema;

/**
 * Auto-generated Migration: Please modify to your need!
 */
class Version20131210165202 extends AbstractMigration
{
    public function up(Schema $schema)
    {
        // this up() migration is autogenerated, please modify it to your needs

    }

    public function down(Schema $schema)
    {
        // this down() migration is autogenerated, please modify it to your needs

    }
}
```

Let's add a column to the… um… admin_user table. Yeah, thats it. This is something we're only doing for the sake of learning, and as such we'll not keep. We're going through the creation, addition and removal of the new column.

```
<?php

namespace Migrations;

use Doctrine\DBAL\Migrations\AbstractMigration,
    Doctrine\DBAL\Schema\Schema;

/**
 * Auto-generated Migration: Please modify to your need!
 */
class Version20131210165202 extends AbstractMigration
{
    public function up(Schema $schema)
    {
        // Get the table, and lets see if we've already made the change.
        $table = $schema->getTable('admin_user');
        if (!$table->hasColumn('testingDoctrine')) {

            // We haven't, and so we do so now.
            $this->addSql('ALTER TABLE admin_user ADD testingDoctrine INT NOT NULL');
        }
    }

    public function down(Schema $schema)
    {
        // Same as above, except we make sure the column was present
        $table = $schema->getTable('admin_user');
        if ($table->hasColumn('testingDoctrine')) {

            // Than we remove it
            $this->addSql('ALTER TABLE admin_user DROP COLUMN testingDoctrine');
        }
    }
}
```

We have the changes that need to be done all ready. I like to make them directly to my development environment manually, and than simply copy/paste the commands back to migrations to keep me from writing it twice.

Once done with my migrations, I'll remove the changes from development so I can test the migrations.

Now lets run the 'up' method from our migration class using doctrine's `migrations:migrate` command, or `m:m` for short. We're going to get a confirmation dialog, just press y:

```
Alert Project Migrations

WARNING! You are about to execute a database migration that could result in schema changes and data lost. Are you sure you wish to continue? (y/n)
y

Migrating up to 20131210165202 from 20130926072305

  ++ migrating 20131210165202

     -> ALTER TABLE admin_user ADD testingDoctrine INT NOT NULL

  ++ migrated (4.78s)

  ------------------------

  ++ finished in 4.78
  ++ 1 migrations executed
  ++ 1 sql queries
```

Great! It worked out just fine. Now if we look at the 'admin_user' table, we can see a new column.

Since we are only testing, we can remove that column by using our 'down' method within our migration class.  To do that we'll use `migrations:execute --down` or `m:e --down`. Once again we get confirmation.

```
./doctrine m:e --down 20131210165202

WARNING! You are about to execute a database migration that could result in schema changes and data lost. Are you sure you wish to continue? (y/n)
y

  -- reverting 20131210165202

     -> ALTER TABLE admin_user DROP COLUMN testingDoctrine

  -- reverted (7.04s)
```

Finally we're done. We've created a migration class, edited it and moved it up and down.

For more information see the various help commands by running the command you want appended with --help

```
./doctrine m:m --help

Usage:
 migrations:migrate [--write-sql] [--dry-run] [--configuration[="..."]] [--db-configuration[="..."]] [version]

Arguments:
 version               The version to migrate to.

Options:
 --write-sql           The path to output the migration SQL file instead of executing it.
 --dry-run             Execute the migration as a dry run.
 --configuration       The path to a migrations configuration file.
 --db-configuration    The path to a database connection configuration file.
 --help (-h)           Display this help message.
 --quiet (-q)          Do not output any message.
 --verbose (-v|vv|vvv) Increase the verbosity of messages: 1 for normal output, 2 for more verbose output and 3 for debug
 --version (-V)        Display this application version.
 --ansi                Force ANSI output.
 --no-ansi             Disable ANSI output.
 --no-interaction (-n) Do not ask any interactive question.

Help:
 The migrations:migrate command executes a migration to a specified version or the latest available version:

     ./doctrine migrations:migrate

 You can optionally manually specify the version you wish to migrate to:

     ./doctrine migrations:migrate YYYYMMDDHHMMSS

 You can also execute the migration as a --dry-run:

     ./doctrine migrations:migrate YYYYMMDDHHMMSS --dry-run

 You can output the would be executed SQL statements to a file with --write-sql:

     ./doctrine migrations:migrate YYYYMMDDHHMMSS --write-sql

 Or you can also execute the migration without a warning message wich you need to interact with:

     ./doctrine migrations:migrate --no-interaction
```

Please remember to delete your test migration, and to verify no changes were actually done on your system that you don't intend to keep.

Finally, if you would like more information on using doctrine for migrations, read through the [Doctrine 2 Migrations Reference Guide](http://docs.doctrine-project.org/projects/doctrine-migrations/en/latest/toc.html).  Just keep in mind we are using version 2.1.5 and the online documentation is for a later version.

Thanks,

-Casey